<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head><script src="/vananh_AWSFCJ.git/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=vananh_AWSFCJ.git/livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.149.1">
    <meta
  name="description"
  content=""
/>
<meta name="author" content="hoangvananh2162004@gmail.com" />

    <link rel="icon" href="http://localhost:1313/vananh_AWSFCJ.git/images/favicon.png" type="image/png">

    <title>Blog 1 :: Report</title>

    
    <link href="http://localhost:1313/vananh_AWSFCJ.git/css/nucleus.css?1762223078" rel="stylesheet">
    <link href="http://localhost:1313/vananh_AWSFCJ.git/css/fontawesome-all.min.css?1762223078" rel="stylesheet">
    <link href="http://localhost:1313/vananh_AWSFCJ.git/css/hybrid.css?1762223078" rel="stylesheet">
    <link href="http://localhost:1313/vananh_AWSFCJ.git/css/featherlight.min.css?1762223078" rel="stylesheet">
    <link href="http://localhost:1313/vananh_AWSFCJ.git/css/perfect-scrollbar.min.css?1762223078" rel="stylesheet">
    <link href="http://localhost:1313/vananh_AWSFCJ.git/css/auto-complete.css?1762223078" rel="stylesheet">
    <link href="http://localhost:1313/vananh_AWSFCJ.git/css/atom-one-dark-reasonable.css?1762223078" rel="stylesheet">
    <link href="http://localhost:1313/vananh_AWSFCJ.git/css/theme.css?1762223078" rel="stylesheet">
    <link href="http://localhost:1313/vananh_AWSFCJ.git/css/hugo-theme.css?1762223078" rel="stylesheet">
    
    <link href="http://localhost:1313/vananh_AWSFCJ.git/css/theme-workshop.css?1762223078" rel="stylesheet">
    
    

    <script src="http://localhost:1313/vananh_AWSFCJ.git/js/jquery-3.3.1.min.js?1762223078"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    

  </head>
  <body class="" data-url="http://localhost:1313/vananh_AWSFCJ.git/3-blogstranslated/3.1-blog1/">
    <nav
  id="sidebar"
  class="showVisitedLinks"
>
   
  <div id="header-wrapper">
    <div id="header"><a id="logo" href="http://localhost:1313/vananh_AWSFCJ.git/">
  <svg
    id="Layer_1"
    data-name="Layer 1"
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 60 30"
    width="30%"
  >
    <defs>
      <style>
        .cls-1 {
          fill: #fff;
        }
        .cls-2 {
          fill: #f90;
          fill-rule: evenodd;
        }
      </style>
    </defs>
    <title>AWS-Logo_White-Color</title>
    <path
      class="cls-1"
      d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"
    ></path>
    <path
      class="cls-2"
      d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"
    ></path>
    <path
      class="cls-2"
      d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"
    ></path>
  </svg>
</a>
</div>
     <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>


<script type="text/javascript" src="http://localhost:1313/vananh_AWSFCJ.git/js/lunr.min.js?1762223078"></script>
<script type="text/javascript" src="http://localhost:1313/vananh_AWSFCJ.git/js/auto-complete.js?1762223078"></script>

<script type="text/javascript">

    var baseurl = "http:\/\/localhost:1313\/vananh_AWSFCJ.git\/";

</script>

<script type="text/javascript" src="http://localhost:1313/vananh_AWSFCJ.git/js/search.js?1762223078"></script>
 
  </div>

  <div class="highlightable">
    <ul class="topics">
               
<li
  data-nav-id="/1-worklog/"
  title="Worklog"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/1-worklog/">
     <b> 1. </b> Worklog 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
  <ul>
          
            
<li
  data-nav-id="/1-worklog/1.1-week1/"
  title="Week 1 Worklog"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/1-worklog/1.1-week1/">
     <b> 1.1. </b> Week 1 Worklog 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/1-worklog/1.2-week2/"
  title="Week 2 Worklog"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/1-worklog/1.2-week2/">
     <b> 1.2. </b> Week 2 Worklog 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/1-worklog/1.3-week3/"
  title="Week 3 Worklog"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/1-worklog/1.3-week3/">
     <b> 1.3. </b> Week 3 Worklog 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/1-worklog/1.4-week4/"
  title="Week 4 Worklog"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/1-worklog/1.4-week4/">
     <b> 1.4. </b> Week 4 Worklog 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/1-worklog/1.5-week5/"
  title="Week 5 Worklog"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/1-worklog/1.5-week5/">
     <b> 1.5. </b> Week 5 Worklog 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/1-worklog/1.6-week6/"
  title="Week 6 Worklog"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/1-worklog/1.6-week6/">
     <b> 1.6. </b> Week 6 Worklog 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/1-worklog/1.7-week7/"
  title="Week 7 Worklog"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/1-worklog/1.7-week7/">
     <b> 1.7. </b> Week 7 Worklog 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/1-worklog/1.8-week8/"
  title="Week 8 Worklog"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/1-worklog/1.8-week8/">
     <b> 1.8. </b> Week 8 Worklog 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/1-worklog/1.9-week9/"
  title="Week 9 Worklog"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/1-worklog/1.9-week9/">
     <b> 1.9. </b> Week 9 Worklog 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/1-worklog/1.10-week10/"
  title="Week 10 Worklog"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/1-worklog/1.10-week10/">
     <b> 1.10. </b> Week 10 Worklog 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/1-worklog/1.11-week11/"
  title="Week 11 Worklog"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/1-worklog/1.11-week11/">
     <b> 1.11. </b> Week 11 Worklog 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/1-worklog/1.12-week12/"
  title="Week 12 Worklog"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/1-worklog/1.12-week12/">
     <b> 1.12. </b> Week 12 Worklog 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
     
  </ul>
  
</li>
           
<li
  data-nav-id="/2-proposal/"
  title="Proposal"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/2-proposal/">
     <b> 2. </b> Proposal 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
           
<li
  data-nav-id="/3-blogstranslated/"
  title="Translated Blogs"
  class="dd-item 
        parent
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/3-blogstranslated/">
     <b> 3. </b> Translated Blogs 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
  <ul>
          
            
<li
  data-nav-id="/3-blogstranslated/3.1-blog1/"
  title="Blog 1"
  class="dd-item 
        
        active
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/3-blogstranslated/3.1-blog1/">
     <b> 3.1. </b> Blog 1 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/3-blogstranslated/3.2-blog2/"
  title="Blog 2"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/3-blogstranslated/3.2-blog2/">
     <b> 3.2. </b> Blog 2 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/3-blogstranslated/3.3-blog3/"
  title="Blog 3"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/3-blogstranslated/3.3-blog3/">
     <b> 3.3. </b> Blog 3 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
     
  </ul>
  
</li>
           
<li
  data-nav-id="/4-eventparticipated/"
  title="Events Participated"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/4-eventparticipated/">
     <b> 4. </b> Events Participated 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
  <ul>
          
            
<li
  data-nav-id="/4-eventparticipated/4.1-event1/"
  title="Event 1"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/4-eventparticipated/4.1-event1/">
     <b> 4.1. </b> Event 1 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/4-eventparticipated/4.2-event2/"
  title="Event 2"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/4-eventparticipated/4.2-event2/">
     <b> 4.2. </b> Event 2 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
     
  </ul>
  
</li>
           
<li
  data-nav-id="/5-workshop/"
  title="Workshop"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/5-workshop/">
     <b> 5. </b> Workshop 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
  <ul>
          
            
<li
  data-nav-id="/5-workshop/5.1-workshop-overview/"
  title="Introduction"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/5-workshop/5.1-workshop-overview/">
     <b> 5.1 </b> Introduction 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
     
  </ul>
  
</li>
           
<li
  data-nav-id="/6-self-evaluation/"
  title="Self-Assessment"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/6-self-evaluation/">
     <b> 6. </b> Self-Assessment 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
           
<li
  data-nav-id="/7-feedback/"
  title="Sharing and Feedback"
  class="dd-item 
        
        
        
        "
>
  <a href="http://localhost:1313/vananh_AWSFCJ.git/7-feedback/">
     <b> 7. </b> Sharing and Feedback 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
    </ul>

     
    <section id="shortcuts">
      <h3>
        More
      </h3>
      <ul>
        
        <li>
          <a class="padding" href="https://www.facebook.com/groups/awsstudygroupfcj/"
            ><i class='fab fa-facebook'></i> AWS Study Group</a
          >
        </li>
        
      </ul>
    </section>
     
    <section id="prefooter">
      <hr />
      <ul>
        
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
            <div class="select-style">
              <select id="select-language" onchange="location = this.value;">
                       
                <option
                  id="en"
                  value="http://localhost:1313/vananh_AWSFCJ.git/3-blogstranslated/3.1-blog1/"
                  selected
                >
                  English
                </option>
                            
                <option
                  id="vi"
                  value="http://localhost:1313/vananh_AWSFCJ.git/vi/3-blogstranslated/3.1-blog1/"
                >
                  Tiếng Việt
                </option>
                   
              </select>
              <svg
                version="1.1"
                id="Capa_1"
                xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                x="0px"
                y="0px"
                width="255px"
                height="255px"
                viewBox="0 0 255 255"
                style="enable-background: new 0 0 255 255"
                xml:space="preserve"
              >
                <g>
                  <g id="arrow-drop-down">
                    <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
                  </g>
                </g>
              </svg>
            </div>
          </a>
        </li>
         
        <li>
          <a class="padding" href="#" data-clear-history-toggle=""
            ><i class="fas fa-history fa-fw"></i> Clear History</a
          >
        </li>
        
      </ul>
    </section>
    
    <section id="footer"><left>
    
    <b> Workshop</b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0"
        title="Migrate" Alt="web counter" border="0" /></a> <br>
    <b> <a href="https://cloudjourney.awsstudygroup.com/">Cloud Journey</a></b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0"
        title="Total CLoud Journey" Alt="web counter" border="0" />

</left>
<left>
    <br>
    <br>
    <b>Last Updated</b><br>
    <i>
        <span id="lastUpdated" style="color:orange;"></span>
    </i>

    <script>
        
        const today = new Date();
        
        const formattedDate = today.toLocaleDateString('en-GB');
        
        document.getElementById('lastUpdated').textContent = formattedDate;
    </script>
</left>
<left>
    <br>
    <br>
    <b> Team </b> <br>

    <i> <a href="https://www.facebook.com/groups/660548818043427" style="color:orange">First Cloud Journey </a> <br>

    </i>
</left>

<script async defer src="https://buttons.github.io/buttons.js"></script></section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='http://localhost:1313/vananh_AWSFCJ.git/'>Internship Report</a> > <a href='http://localhost:1313/vananh_AWSFCJ.git/3-blogstranslated/'>Translated Blogs</a> > Blog 1
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
  <div class="wrapper"><nav id="TableOfContents">
  <ul>
    <li><a href="#background">Background</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#walkthrough">Walkthrough</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#cleaning-up">Cleaning up</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav></div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Blog 1
            </h1>
          

        



	<h1 id="extending-deployment-pipelines-with-amazon-ecs-blue-green-deployments-and-lifecycle-hooks">Extending deployment pipelines with Amazon ECS blue green deployments and lifecycle hooks.</h1>
<p>by Olly Pomeroy | on 11 SEP 2025 | in <a href="https://aws.amazon.com/blogs/containers/category/compute/amazon-elastic-container-service/">Amazon Elastic Container Service</a>, <a href="https://aws.amazon.com/blogs/containers/category/containers/">Containers</a> | <a href="https://aws.amazon.com/blogs/containers/extending-deployment-pipelines-with-amazon-ecs-blue-green-deployments-and-lifecycle-hooks/">Permalink</a></p>
<p>The <a href="https://docs.aws.amazon.com/whitepapers/latest/blue-green-deployments/welcome.html">blue/green deployment</a> enables you to release applications by shifting traffic between two identical environments running different versions of the application. This allows you to mitigate common risks associated with deploying software, because you can roll back to a previous deployment instantly. Amazon Elastic Container Service (<a href="https://aws.amazon.com/ecs/">Amazon ECS</a>) recently announced native support for blue/green deployments, removing the need to manage and integrate with other deployment tools. As part of this release, Amazon ECS has also introduced lifecycle hooks for deployments. Lifecycle hooks allow you to integrate test suites, manual approvals, and metrics into your deployment pipeline. In this post we dive into lifecycle hooks and show how they can be integrated into deployment workflows.</p>
<h2 id="background">Background</h2>
<p>When an Amazon ECS <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_services.html">service</a> is created or updated, we create an immutable object of its exact specification, known as an Amazon ECS <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-revision.html">service revision</a>. Then, the control plane attempts to deploy this service revision through an Amazon ECS <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-deployment.html">service deployment</a>. A deployment goes through <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-deployment.html#service-deployments-states">multiple lifecycle states</a>, such as IN_PROGRESS and SUCCESSFUL. As part of the recent blue/green release, there is a new subcategory underneath these states, known as lifecycle stages. When a deployment has started, we work through each lifecycle stage linearly, with the option to extend the deployment with custom logic packaged in lifecycle hooks. The following figure shows the relationship between lifecycle states, lifecycle stages, and lifecycle hooks.</p>
<p><img src="http://localhost:1313/vananh_AWSFCJ.git/static/images/C45-1.png" alt="anh"></p>
<p>Lifecycle hooks are synchronous <a href="https://aws.amazon.com/lambda/">AWS Lambda</a> functions that the Amazon ECS control plane invokes on your behalf. You can write any logic you’d like in these functions in any runtime language you choose. When the function has finished executing its logic, it must return a hookStatus for the Amazon ECS deployment to continue. If a hookStatus is not returned, or if the function fails, then the Amazon ECS deployment rolls back.</p>
<p>The values of the hookStatus can either be:</p>
<ul>
<li><code>SUCCEEDED</code>: the deployment continues to the next lifecycle stage.</li>
<li><code>FAILED</code>: the deployment rolls back to the last successful deployment.</li>
<li><code>IN_PROGRESS</code>: the Amazon ECS control plane invokes the function again after a short period of time. By default, this is 30 seconds, but this can be tuned by returning a <code>callBackDelay</code>.</li>
</ul>
<p><img src="http://localhost:1313/vananh_AWSFCJ.git/static/images/C45-2.png" alt="anh"></p>
<h4 id="in_progress-hook-status">IN_PROGRESS hook status</h4>
<p>The <code>IN_PROGRESS</code> status provides a powerful and flexible mechanism to monitor and control the Amazon ECS deployment. The function is a synchronous event, thus the deployment can only pause for the maximum execution time of a function (15 minutes). There may be scenarios where you need to execute complex logic or pause for more data, such as waiting for a full test suite to run against the test endpoint. This <code>hookStatus</code> response allows you to achieve this. When the <code>IN_PROGRESS</code> hook status is returned, the Amazon ECS control plane will invoke the function again in 30 seconds (or the time returned in the <code>callBackDelay</code> key). Amazon ECS will continue to invoke the function until a <code>SUCCEEDED</code> or <code>FAILED</code> hook status is returned; therefore, allowing for validation logic that needs more time than the execution time of a single function.</p>
<h4 id="passing-state-with-hookdetails">Passing state with hookDetails</h4>
<p>Lifecycle hooks are often defined once and reused across multiple ECS services within an organization. To make lifecycle hooks ECS service agnostic, you can use the <code>hookDetails</code> dictionary to pass in service specific data when creating or update a service. Below is an extract from a <a href="https://docs.aws.amazon.com/AmazonECS/latest/APIReference/API_CreateService.html">ECS service</a> where we have defined a lifecycle hook and passed in an <a href="https://aws.amazon.com/s3/">Amazon S3 Bucket</a> name.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;hookTargetArn&#34;: </span><span style="color:#e6db74">&#34;arn:aws:lambda:&lt;region&gt;:&lt;account_id&gt;:function:&lt;function_name&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;roleArn&#34;: </span><span style="color:#e6db74">&#34;arn:aws:iam::&lt;account_id&gt;:role/&lt;iam_role_name&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;lifecycleStages&#34;: </span>[<span style="color:#e6db74">&#34;POST_TEST_TRAFFIC_SHIFT&#34;</span>],
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;hookDetails&#34;: { &#34;S3_BUCKET_NAME&#34;: </span><span style="color:#e6db74">&#34;mys3bucket&#34;</span> },
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Furthermore, you can also use the <code>hookDetails</code> dictionary to pass state between invocations of the same lifecycle hook. If a hook returns the <code>IN_PROGRESS</code> status, you can also include the <code>hookDetails</code> dictionary with multiple key / value pairs, removing the need to store state elsewhere. Common use cases include passing metric counters or <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference-arns.html">Amazon Resource Names (ARNs)</a> of external resources between invocations. Note data added to <code>hookDetails</code> in this way only persists between invocations of the same hook within a single deployment. Data doesn’t carry over between different hooks within the same deployment or the same hook in different deployments.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;hookStatus&#34;: </span><span style="color:#e6db74">&#34; IN_PROGRESS&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;callBackDelay&#34;: </span><span style="color:#ae81ff">90</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;hookDetails&#34;</span>:
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;SFN_EXECUTION_ARN&#34;: </span><span style="color:#e6db74">&#34;arn:aws:states:&lt;region&gt;:&lt;account_id&gt;:execution:&lt;sfn&gt;:&lt;id&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="pre_scale_up-hook">PRE_SCALE_UP hook</h4>
<p>The <code>PRE_SCALE_UP</code> lifecycle hook is unique in Amazon ECS deployments as it is the only hook available for both the new <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/deployment-type-bluegreen.html">blue green deployment strategy</a> as well as the existing <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/deployment-type-ecs.html">rolling update strategy</a>. The <code>PRE_SCALE_UP</code> hook runs before new tasks are created, allowing you to apply admission logic in Amazon ECS. A common use of this hook is to evaluate the Amazon ECS task definition against a governance policy before the tasks have been scheduled. Previously, if you wanted to enforce a policy to tasks, then you could only respond to a task once it has been scheduled. An example of the previous pattern can be found in this <a href="https://github.com/aws-samples/lambda-based-signature-verification">GitHub repository</a>. This previous pattern had limitations where insecure or vulnerable tasks could be running before your policy detected an infringement. This new hook enables use cases such as verifying a container image signature or a container image repository before the workload has been scheduled.</p>
<h2 id="walkthrough">Walkthrough</h2>
<p>In this walkthrough we are going to show different patterns to demonstrate the power of lifecycle hooks. We will first showcase how a <code>PRE_SCALE_UP</code> hook can be used as form of admission hook, secondly, we will show a <code>POST_TEST_TRAFFIC_SHIFT</code> hook can be used to apply a manual approval step before production traffic is shifted.</p>
<h4 id="prerequisites">Prerequisites</h4>
<p>To deploy this walk through you need access to an AWS account with a workstation with the AWS Command Line Interface <a href="https://aws.amazon.com/cli/">(AWS CLI)</a>, AWS Cloud Development Kit <a href="https://aws.amazon.com/cdk/">(AWS CDK)</a>, and Docker Engine installed.</p>
<p>Throughout this walkthrough we deploy resources on to an Amazon ECS cluster and into an Amazon Virtual Private Cloud <a href="https://aws.amazon.com/vpc/">(Amazon VPC)</a>. The code for this walk through can be found in an AWS CDK app within our sample <a href="https://github.com/aws-samples/sample-amazon-ecs-blue-green-deployment-patterns">GitHub repository</a>.</p>
<ol>
<li>Clone down the GitHub Repository</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ git clone https://github.com/aws-samples/sample-amazon-ecs-blue-green-deployment-patterns.git</span>
</span></span></code></pre></div><ol start="2">
<li>Deploy the AWS CDK app. This AWS CDK app contains three separate <a href="https://aws.amazon.com/cloudformation/">AWS CloudFormation stacks</a>. It creates an Amazon VPC and <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html">Application Load Balancer (ALB)</a> in the first stack. In the second, it creates an ECS cluster and necessary AWS Identity and Access Management (<a href="https://aws.amazon.com/iam/">IAM</a>) roles. Third, it creates a stack containing our functions.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ cd sample-amazon-ecs-blue-green-deployment-patterns/ecs-bluegreen-lifecycle-hooks</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">$ npm install</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">$ npm run build</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">$ npx cdk deploy --all</span>
</span></span></code></pre></div><p>You can verify that the resources were created correctly with the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ aws cloudformation list-stacks \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">query &#34;StackSummaries[?starts_with(StackName, &#39;Ecs&#39;)].[StackName, StackStatus]&#34; \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">output table</span>
</span></span></code></pre></div><ol start="3">
<li>Within this repository we have a template task definition and service definition. We have created a populate templates bash script within the repository to populate these templates with the values relevant to your environment.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ ./populate_templates.sh</span>
</span></span></code></pre></div><h4 id="admission-hook-demonstration">Admission hook demonstration</h4>
<p>To demonstrate how a <code>PRE_SCALE_UP</code> hook can be used as an admission hook, we are going to start an Amazon ECS service using a container image from an Amazon Elastic Container Registry (<a href="https://aws.amazon.com/ecr/">Amazon ECR</a>) public repository. In our scenario, we have written a policy in our function to make sure that all container images come from either a private or public Amazon ECR repository. We can see this policy being enforced in the logs of our lifecycle hook.</p>
<ol>
<li>First, we look at the resources we plan to deploy:
Inside of our service definition you should find a <code>PRE_SCALE_UP</code> lifecycle hook.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ cat outputs/service.json | jq -r &#39;.deploymentConfiguration.lifecycleHooks[0]&#39;</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;hookTargetArn&#34;: </span><span style="color:#e6db74">&#34;arn:aws:lambda:us-east-1:111222333444:function:EcsBluegreenHookStack-admissionFunction1D626CB0-FepCuhdYPhNn&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;roleArn&#34;: </span><span style="color:#e6db74">&#34;arn:aws:iam::111222333444:role/EcsBluegreenEcsStack-ECSLambdaInvokeRole2A82A552-yEE1nb8PewjH&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;lifecycleStages&#34;: </span>[
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;PRE_SCALE_UP&#34;</span>
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The function for this hook verifies our container image using a regex expression. You can see that piece of code locally by printing the source code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ grep -A 20 &#34;def validate_container_images&#34; src/admissionFunction/app.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">def validate_container_images(container_image_list)</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Regex patterns to match Amazon ECR repository URLs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Format for private ECR: [account-id].dkr.ecr.[region].amazonaws.com/[repository-name]:[tag]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Format for public ECR: public.ecr.aws/aws-containers/[repository-name]:[tag]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">private_ecr_pattern = r&#34;^(\d+)\.dkr\.ecr\.([a-z0-9-]+)\.amazonaws\.com/.*&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">public_ecr_pattern = r&#34;^public\.ecr\.aws/aws-containers/.*&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">valid_images = True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">for container_image in container_image_list:#</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">image_url = container_image[&#34;image&#34;]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">logger.info(f&#34;Validating image: {image_url}&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">if re.match(private_ecr_pattern, image_url) or re.match(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">public_ecr_pattern, image_url</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">logger.info(f&#34;Image {image_url} is from an Amazon ECR repository&#34;)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">logger.warning(f&#34;Image {image_url} is NOT from an Amazon ECR repository&#34;)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">valid_images = False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">return valid_images</span>
</span></span></code></pre></div><p>Finally, you can see what container image we are attempting to deploy within our task definition.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ cat outputs/taskdef.json | jq -r &#39;.containerDefinitions[0].image&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">public.ecr.aws/aws-containers/retail-store-sample-ui:1.1.0</span>
</span></span></code></pre></div><ol start="2">
<li>We create the Amazon ECS service and see the lifecycle hook in action.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">aws ecs \</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">register-task-definition \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">cli-input-json file://outputs/taskdef.json</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">aws ecs \</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">create-service \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">cli-input-json file://outputs/service.json</span>
</span></span></code></pre></div><ol start="3">
<li>In the Amazon <a href="https://us-west-2.console.aws.amazon.com/ecs/home">console</a> you can monitor this deployment. The** Current Deployment stage** within the <strong>Deployment tab</strong> shows us which stage of the lifecycle the deployment is in. Remember our first lifecycle hook runs at the <code>PRE_SCALE_UP</code> stage.</li>
</ol>
<p><img src="http://localhost:1313/vananh_AWSFCJ.git/static/images/C45-3.png" alt="anh"></p>
<ol start="4">
<li>You can verify that the lifecycle hook executed successfully by browsing to the <a href="https://aws.amazon.com/cloudwatch/">Amazon CloudWatch Logs console</a>, and choosing the Log Group starting with the name <code>/aws/lambda/EcsBlugreenHookStack-admissionFunction</code>.</li>
</ol>
<p><img src="http://localhost:1313/vananh_AWSFCJ.git/static/images/C45-4.png" alt="anh"></p>
<p>Success! The container images used within our task definition were verified against our policy before the task was scheduled.</p>
<h4 id="manual-approval-demonstration">Manual approval demonstration</h4>
<p>The second part of our walkthrough focuses on a manual approval step at the <code>POST_TEST_TRAFFIC_SHIFT</code> stage. This is a critical stage in our deployment pipeline, because it’s after the test traffic endpoint has been shifted to our green tasks (allowing you to a run a test suite), but before the production traffic endpoint has been moved.</p>
<p>In this walkthrough we implement a manual approval step before migrating the production traffic. There are lots of ways to implement a manual approval step, but in this demonstration, we use a file and an <a href="https://aws.amazon.com/s3/">Amazon S3</a> bucket. The function in our lifecycle hook attempts to find a file in an S3 bucket named after the Amazon ECS service revision. If the file exists, then the deployment pipeline continues. If the file does not exist, then the hook returns an <code>IN_PROGRESS</code> state and we try again in 30 seconds.</p>
<ol>
<li>First, we look at the resources that we plan to deploy.
Inside of our service definition we should find a <code>POST_TEST_TRAFFIC_SHIFT</code> lifecycle hook.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ cat outputs/service.json | jq -r &#39;.deploymentConfiguration.lifecycleHooks[1]&#39;</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;hookTargetArn&#34;: </span><span style="color:#e6db74">&#34;arn:aws:lambda:us-east-1:111222333444:function:EcsBluegreenHookStack-approvalFunctionC7093965-J3YoEQtxR679&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;roleArn&#34;: </span><span style="color:#e6db74">&#34;arn:aws:iam::111222333444:role/EcsBluegreenEcsStack-ECSLambdaInvokeRole2A82A552-9OcKcmXkLe9c&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;lifecycleStages&#34;: </span>[
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;POST_TEST_TRAFFIC_SHIFT&#34;</span>
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Browsing the function source code locally allows us to look at the logic to find the Amazon S3 file. We are using the <a href="https://aws.amazon.com/sdk-for-python/">boto3client</a> to attempt to find the head object of a file named after our Amazon ECS service revision ID.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ grep -A 20 &#34;def check_s3_file&#34; src/approvalFunction/app.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">def check_s3_file(s3_bucket, revision_arn)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract the revision from the ARN (everything after the last &#39;/&#39;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">revision = revision_arn.split(&#34;/&#34;)[-1]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">file_name = f&#34;{revision}.txt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">logger.info(f&#34;Checking if file {file_name} exists in bucket {s3_bucket}&#34;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create S3 client</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">s3_client = boto3.client(&#34;s3&#34;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Use head_object to check if the file exists</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">s3_client.head_object(Bucket=s3_bucket, Key=file_name)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">logger.info(f&#34;File {file_name} exists in bucket {s3_bucket}&#34;)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">return True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">except ClientError as e</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">if e.response[&#34;Error&#34;][&#34;Code&#34;] == &#34;404&#34;:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># The file does not exist</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">logger.info(f&#34;File {file_name} does not exist in bucket {s3_bucket}&#34;)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">return False</span>
</span></span></code></pre></div><ol start="2">
<li>To trigger a deployment, we update our Amazon ECS service with a force action. This forces Amazon ECS to create a new service revision and redeploy all the tasks, even though the service specification hasn’t changed.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">export CLUSTER_NAME=$(cat outputs/service.json | jq -r &#39;.cluster&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">export SERVICE_NAME=$(cat outputs/service.json | jq -r &#39;.serviceName&#39;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">aws ecs \</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">update-service \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">service $SERVICE_NAME \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">cluster $CLUSTER_NAME \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">force</span>
</span></span></code></pre></div><ol start="3">
<li>You can monitor the ongoing deployment in the Amazon <a href="https://us-west-2.console.aws.amazon.com/ecs/home">ECS console</a>, watching the service move through the various lifecycle stages. When the deployment reaches the <code>POST_TEST_TRAFFIC_SHIFT</code> stage, we can check the progress of our hook.</li>
</ol>
<p><img src="http://localhost:1313/vananh_AWSFCJ.git/static/images/C45-5.png" alt="anh"></p>
<ol start="4">
<li>The CloudWatch Logs console gives us insight into what is happening at this stage. In a log group starting with <code>/aws/lambda/EcsBlugreenHookStack-approvalFunction</code>, we should see invocations of our function every 30 seconds attempting to retrieving the file from Amazon S3.</li>
</ol>
<p><img src="http://localhost:1313/vananh_AWSFCJ.git/static/images/C45-6.png" alt="anh"></p>
<ol start="5">
<li>To allow our deployment pipeline to continue, we upload a file to the S3 bucket. First, we need to retrieve the Amazon ECS service revision ARN, shorten it to just the service revision ID, and use that as the file name.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">export S3_BUCKET_NAME=$(aws cloudformation describe-stacks \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">stack-name EcsBluegreenHookStack \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">query &#39;Stacks[0].Outputs[?OutputKey==`ApprovalBucketName`].OutputValue&#39; \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">output text)</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">export ECS_SERVICE_REVISION=$(aws ecs \</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">list-service-deployments \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">service $SERVICE_NAME \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">cluster $CLUSTER_NAME \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">query &#39;serviceDeployments[?status==`IN_PROGRESS`].targetServiceRevisionArn&#39; \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">output text)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">SERVICE_REVISION_ID=$(echo &#34;$ECS_SERVICE_REVISION&#34; | awk -F/ &#39;{print $NF}&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">touch $SERVICE_REVISION_ID.txt</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">aws s3 cp $SERVICE_REVISION_ID.txt s3://$S3_BUCKET_NAME/$SERVICE_REVISION_ID.txt</span>
</span></span></code></pre></div><ol start="6">
<li>Now that the file exists in Amazon S3, we can go back to the Amazon ECS console and watch the deployment complete.</li>
</ol>
<p><img src="http://localhost:1313/vananh_AWSFCJ.git/static/images/C45-7.png" alt="anh"></p>
<h2 id="cleaning-up">Cleaning up</h2>
<p>To clean up the AWS resources used throughout this walkthrough, we must remove the Amazon ECS service.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ aws ecs \</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">delete-service \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">service $SERVICE_NAME \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">cluster $CLUSTER_NAME \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">force</span>
</span></span></code></pre></div><p>Next, we delete the <strong>CloudFormation</strong> stacks using <strong>AWS CDK</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ cdk destroy --all</span>
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>Lifecycle hooks in Amazon ECS provide endless possibilities to customize your deployment pipeline. In this post we have covered a few common use cases for these hooks, such as evaluating a deployment against governance policies, as well as implementing a manual approval step. To learn more, go to the Amazon ECS lifecycle hooks <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/deployment-type-bluegreen.html">documentation</a>, and watch demonstrations on the Containers from the Couch <a href="https://www.youtube.com/ContainersFromTheCouch">YouTube</a> channel.</p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="http://localhost:1313/vananh_AWSFCJ.git/3-blogstranslated/" title="Translated Blogs"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="http://localhost:1313/vananh_AWSFCJ.git/3-blogstranslated/3.2-blog2/" title="Blog 2" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="http://localhost:1313/vananh_AWSFCJ.git/js/clipboard.min.js?1762223078"></script>
    <script src="http://localhost:1313/vananh_AWSFCJ.git/js/perfect-scrollbar.min.js?1762223078"></script>
    <script src="http://localhost:1313/vananh_AWSFCJ.git/js/perfect-scrollbar.jquery.min.js?1762223078"></script>
    <script src="http://localhost:1313/vananh_AWSFCJ.git/js/jquery.sticky.js?1762223078"></script>
    <script src="http://localhost:1313/vananh_AWSFCJ.git/js/featherlight.min.js?1762223078"></script>
    <script src="http://localhost:1313/vananh_AWSFCJ.git/js/highlight.pack.js?1762223078"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="http://localhost:1313/vananh_AWSFCJ.git/js/modernizr.custom-3.6.0.js?1762223078"></script>
    <script src="http://localhost:1313/vananh_AWSFCJ.git/js/learn.js?1762223078"></script>
    <script src="http://localhost:1313/vananh_AWSFCJ.git/js/hugo-learn.js?1762223078"></script>

    <link href="http://localhost:1313/vananh_AWSFCJ.git/mermaid/mermaid.css?1762223078" rel="stylesheet" />
    <script src="http://localhost:1313/vananh_AWSFCJ.git/mermaid/mermaid.js?1762223078"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function (i, s, o, g, r, a, m) {
    i["GoogleAnalyticsObject"] = r;
    ((i[r] =
      i[r] ||
      function () {
        (i[r].q = i[r].q || []).push(arguments);
      }),
      (i[r].l = 1 * new Date()));
    ((a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]));
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m);
  })(
    window,
    document,
    "script",
    "https://www.google-analytics.com/analytics.js",
    "ga",
  );

  ga("create", "UA-158079754-2", "auto");
  ga("send", "pageview");
</script>

  </body>
</html>
