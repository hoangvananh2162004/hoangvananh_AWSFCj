<!DOCTYPE html>
<html lang="vi" class="js csstransforms3d">
  <head><script src="/hoangvananh2162004/hoangvananh2162004.github.io.git/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=hoangvananh2162004/hoangvananh2162004.github.io.git/livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.149.1">
    <meta
  name="description"
  content=""
/>
<meta name="author" content="anhhvse180142@fpt.edu.vn" />

    <link rel="icon" href="../../../images/favicon.png" type="image/png">

    <title>Blog 1 :: Báo Cáo</title>

    
    <link href="../../../css/nucleus.css?1761460639" rel="stylesheet">
    <link href="../../../css/fontawesome-all.min.css?1761460639" rel="stylesheet">
    <link href="../../../css/hybrid.css?1761460639" rel="stylesheet">
    <link href="../../../css/featherlight.min.css?1761460639" rel="stylesheet">
    <link href="../../../css/perfect-scrollbar.min.css?1761460639" rel="stylesheet">
    <link href="../../../css/auto-complete.css?1761460639" rel="stylesheet">
    <link href="../../../css/atom-one-dark-reasonable.css?1761460639" rel="stylesheet">
    <link href="../../../css/theme.css?1761460639" rel="stylesheet">
    <link href="../../../css/hugo-theme.css?1761460639" rel="stylesheet">
    
    <link href="../../../css/theme-workshop.css?1761460639" rel="stylesheet">
    
    

    <script src="../../../js/jquery-3.3.1.min.js?1761460639"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    

  </head>
  <body class="" data-url="../../../vi/3-blogstranslated/3.1-blog1/">
    <nav
  id="sidebar"
  class="showVisitedLinks"
>
   
  <div id="header-wrapper">
    <div id="header"><a id="logo" href="../../../">
  <svg
    id="Layer_1"
    data-name="Layer 1"
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 60 30"
    width="30%"
  >
    <defs>
      <style>
        .cls-1 {
          fill: #fff;
        }
        .cls-2 {
          fill: #f90;
          fill-rule: evenodd;
        }
      </style>
    </defs>
    <title>AWS-Logo_White-Color</title>
    <path
      class="cls-1"
      d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"
    ></path>
    <path
      class="cls-2"
      d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"
    ></path>
    <path
      class="cls-2"
      d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"
    ></path>
  </svg>
</a>
</div>
     <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>


<script type="text/javascript" src="../../../js/lunr.min.js?1761460639"></script>
<script type="text/javascript" src="../../../js/auto-complete.js?1761460639"></script>

<script type="text/javascript">

    var baseurl = "http:\/\/localhost:1313\/hoangvananh2162004\/hoangvananh2162004.github.io.git\/\/vi";

</script>

<script type="text/javascript" src="../../../js/search.js?1761460639"></script>
 
  </div>

  <div class="highlightable">
    <ul class="topics">
               
<li
  data-nav-id="/vi/1-worklog/"
  title="Nhật ký công việc"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/1-worklog/">
     <b> 1. </b> Nhật ký công việc 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
  <ul>
          
            
<li
  data-nav-id="/vi/1-worklog/1.1-week1/"
  title="Worklog Tuần 1"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/1-worklog/1.1-week1/">
     <b> 1.1. </b> Worklog Tuần 1 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/vi/1-worklog/1.2-week2/"
  title="Worklog Tuần 2"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/1-worklog/1.2-week2/">
     <b> 1.2. </b> Worklog Tuần 2 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/vi/1-worklog/1.3-week3/"
  title="Worklog Tuần 3"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/1-worklog/1.3-week3/">
     <b> 1.3. </b> Worklog Tuần 3 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/vi/1-worklog/1.4-week4/"
  title="Worklog Tuần 4"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/1-worklog/1.4-week4/">
     <b> 1.4. </b> Worklog Tuần 4 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/vi/1-worklog/1.5-week5/"
  title="Worklog Tuần 5"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/1-worklog/1.5-week5/">
     <b> 1.5. </b> Worklog Tuần 5 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/vi/1-worklog/1.6-week6/"
  title="Worklog Tuần 6"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/1-worklog/1.6-week6/">
     <b> 1.6. </b> Worklog Tuần 6 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/vi/1-worklog/1.7-week7/"
  title="Worklog Tuần 7"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/1-worklog/1.7-week7/">
     <b> 1.7. </b> Worklog Tuần 7 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/vi/1-worklog/1.8-week8/"
  title="Worklog Tuần 8"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/1-worklog/1.8-week8/">
     <b> 1.8. </b> Worklog Tuần 8 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/vi/1-worklog/1.9-week9/"
  title="Worklog Tuần 9"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/1-worklog/1.9-week9/">
     <b> 1.9. </b> Worklog Tuần 9 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/vi/1-worklog/1.10-week10/"
  title="Worklog Tuần 10"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/1-worklog/1.10-week10/">
     <b> 1.10. </b> Worklog Tuần 10 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/vi/1-worklog/1.11-week11/"
  title="Worklog Tuần 11"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/1-worklog/1.11-week11/">
     <b> 1.11. </b> Worklog Tuần 11 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/vi/1-worklog/1.12-week12/"
  title="Worklog Tuần 12"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/1-worklog/1.12-week12/">
     <b> 1.12 </b> Worklog Tuần 12 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
     
  </ul>
  
</li>
           
<li
  data-nav-id="/vi/2-proposal/"
  title="Bản đề xuất"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/2-proposal/">
     <b> 2. </b> Bản đề xuất 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
           
<li
  data-nav-id="/vi/3-blogstranslated/"
  title="Các bài blogs đã dịch"
  class="dd-item 
        parent
        
        
        "
>
  <a href="../../../vi/3-blogstranslated/">
     <b> 3. </b> Các bài blogs đã dịch 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
  <ul>
          
            
<li
  data-nav-id="/vi/3-blogstranslated/3.1-blog1/"
  title="Blog 1"
  class="dd-item 
        
        active
        
        "
>
  <a href="../../../vi/3-blogstranslated/3.1-blog1/">
     <b> 3.1. </b> Blog 1 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/vi/3-blogstranslated/3.2-blog2/"
  title="Blog 2"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/3-blogstranslated/3.2-blog2/">
     <b> 3.2. </b> Blog 2 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/vi/3-blogstranslated/3.3-blog3/"
  title="Blog 3"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/3-blogstranslated/3.3-blog3/">
     <b> 3.3. </b> Blog 3 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
     
  </ul>
  
</li>
           
<li
  data-nav-id="/vi/4-eventparticipated/"
  title="Các events đã tham gia"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/4-eventparticipated/">
     <b> 4. </b> Các events đã tham gia 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
  <ul>
          
            
<li
  data-nav-id="/vi/4-eventparticipated/4.1-event1/"
  title="Event 1"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/4-eventparticipated/4.1-event1/">
     <b> 4.1. </b> Event 1 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/vi/4-eventparticipated/4.2-event2/"
  title="Event 2"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/4-eventparticipated/4.2-event2/">
     <b> 4.2. </b> Event 2 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
     
  </ul>
  
</li>
           
<li
  data-nav-id="/vi/5-workshop/"
  title="Workshop"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/5-workshop/">
     <b> 5. </b> Workshop 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
  <ul>
          
            
<li
  data-nav-id="/vi/5-workshop/5.1-workshop-overview/"
  title="Giới thiệu"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/5-workshop/5.1-workshop-overview/">
     <b> 5.1 </b> Giới thiệu 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
            
<li
  data-nav-id="/vi/5-workshop/5.2-prerequiste/"
  title="Các bước chuẩn bị"
  class="dd-item "
>
  <a href="../../../vi/5-workshop/5.2-prerequiste/">
     <b> 5.2 </b> Các bước chuẩn bị <i
      class="fas fa-check read-icon"
    ></i
    >
  </a>
</li>
      
  </ul>
  
</li>
           
<li
  data-nav-id="/vi/6-self-evaluation/"
  title="Tự đánh giá"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/6-self-evaluation/">
     <b> 6. </b> Tự đánh giá 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
           
<li
  data-nav-id="/vi/7-feedback/"
  title="Chia sẻ, đóng góp ý kiến"
  class="dd-item 
        
        
        
        "
>
  <a href="../../../vi/7-feedback/">
     <b> 7. </b> Chia sẻ, đóng góp ý kiến 
    <i class="fas fa-check read-icon"></i>
    
  </a>
   
</li>
    
    </ul>

     
    <section id="shortcuts">
      <h3>
        More
      </h3>
      <ul>
        
        <li>
          <a class="padding" href="https://www.facebook.com/groups/awsstudygroupfcj/"
            ><i class='fab fa-facebook'></i> AWS Study Group</a
          >
        </li>
        
      </ul>
    </section>
     
    <section id="prefooter">
      <hr />
      <ul>
        
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
            <div class="select-style">
              <select id="select-language" onchange="location = this.value;">
                       
                <option
                  id="en"
                  value="http://localhost:1313/hoangvananh2162004/hoangvananh2162004.github.io.git/3-blogstranslated/3.1-blog1/"
                >
                  English
                </option>
                            
                <option
                  id="vi"
                  value="http://localhost:1313/hoangvananh2162004/hoangvananh2162004.github.io.git/vi/3-blogstranslated/3.1-blog1/"
                  selected
                >
                  Tiếng Việt
                </option>
                   
              </select>
              <svg
                version="1.1"
                id="Capa_1"
                xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                x="0px"
                y="0px"
                width="255px"
                height="255px"
                viewBox="0 0 255 255"
                style="enable-background: new 0 0 255 255"
                xml:space="preserve"
              >
                <g>
                  <g id="arrow-drop-down">
                    <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
                  </g>
                </g>
              </svg>
            </div>
          </a>
        </li>
         
        <li>
          <a class="padding" href="#" data-clear-history-toggle=""
            ><i class="fas fa-history fa-fw"></i> Clear History</a
          >
        </li>
        
      </ul>
    </section>
    
    <section id="footer"><left>
    
    <b> Workshop</b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0"
        title="Migrate" Alt="web counter" border="0" /></a> <br>
    <b> <a href="https://cloudjourney.awsstudygroup.com/">Cloud Journey</a></b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0"
        title="Total CLoud Journey" Alt="web counter" border="0" />

</left>
<left>
    <br>
    <br>
    <b>Last Updated</b><br>
    <i>
        <span id="lastUpdated" style="color:orange;"></span>
    </i>

    <script>
        
        const today = new Date();
        
        const formattedDate = today.toLocaleDateString('en-GB');
        
        document.getElementById('lastUpdated').textContent = formattedDate;
    </script>
</left>
<left>
    <br>
    <br>
    <b> Team </b> <br>

    <i> <a href="https://www.facebook.com/groups/660548818043427" style="color:orange">First Cloud Journey </a> <br>

    </i>
</left>

<script async defer src="https://buttons.github.io/buttons.js"></script></section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='../../../vi/'>Báo cáo thực tập</a> > <a href='../../../vi/3-blogstranslated/'>Các bài blogs đã dịch</a> > Blog 1
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
  <div class="wrapper"><nav id="TableOfContents">
  <ul>
    <li><a href="#bối-cảnh">Bối Cảnh</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#walkthrough">Walkthrough</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#dọn-dẹp">Dọn dẹp</a></li>
    <li><a href="#kết-luận">Kết luận</a></li>
  </ul>
</nav></div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Blog 1
            </h1>
          

        



	<h1 id="mở-rộng-deployment-pipeline-với-amazon-ecs-bluegreen-deployments-và-lifecycle-hooks">Mở rộng deployment pipeline với Amazon ECS blue/green deployments và lifecycle hooks.</h1>
<p>Bởi Olly Pomeroy | vào ngày 11 THÁNG 9, 2025 | trong <a href="https://aws.amazon.com/blogs/containers/category/compute/amazon-elastic-container-service/">Amazon Elastic Container Service</a>, <a href="https://aws.amazon.com/blogs/containers/category/containers/">Containers</a> | <a href="https://aws.amazon.com/blogs/containers/extending-deployment-pipelines-with-amazon-ecs-blue-green-deployments-and-lifecycle-hooks/">Permalink</a></p>
<p>Chiến lược <a href="https://docs.aws.amazon.com/whitepapers/latest/blue-green-deployments/welcome.html">blue/green deployment</a> cho phép bạn release ứng dụng bằng cách chuyển hướng traffic giữa hai môi trường giống hệt nhau đang chạy các phiên bản khác nhau của ứng dụng. Điều này giúp bạn giảm thiểu các rủi ro thường gặp khi deploy phần mềm, bởi vì bạn có thể rollback về một deployment trước đó ngay lập tức. Amazon Elastic Container Service (<a href="https://aws.amazon.com/ecs/">Amazon ECS</a>) gần đây đã công bố hỗ trợ native cho blue/green deployments, loại bỏ nhu cầu quản lý và tích hợp với các công cụ deployment khác. Như một phần của lần phát hành này, Amazon ECS cũng đã giới thiệu lifecycle hooks cho deployments. Lifecycle hooks cho phép bạn tích hợp test suites, manual approvals, và metrics vào deployment pipeline của mình. Trong bài viết này, chúng tôi sẽ đi sâu vào lifecycle hooks và chỉ ra cách chúng có thể được tích hợp vào deployment workflows.</p>
<h2 id="bối-cảnh">Bối Cảnh</h2>
<p>Khi một Amazon ECS <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_services.html">service</a> được tạo hoặc cập nhật, chúng tôi sẽ tạo ra một immutable object chứa chính xác specification của nó, được gọi là một Amazon ECS <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-revision.html">service revision</a>. Sau đó, control plane sẽ cố gắng deploy service revision này thông qua một Amazon ECS <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-deployment.html">service deployment</a>. Một deployment sẽ trải qua <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-deployment.html#service-deployments-states">multiple lifecycle states</a>, chẳng hạn như <code>IN_PROGRESS</code> và <code>SUCCESSFUL</code>. Trong lần phát hành blue/green gần đây, có một subcategory mới nằm bên dưới các states này, được gọi là lifecycle stages. Khi một deployment bắt đầu, chúng tôi sẽ xử lý tuần tự qua từng lifecycle stage, với tùy chọn mở rộng deployment bằng custom logic được đóng gói trong lifecycle hooks. Hình minh họa sau đây cho thấy mối quan hệ giữa lifecycle states, lifecycle stages, và lifecycle hooks.</p>
<p><img src="../../../images/C45-1.png" alt="anh"></p>
<p>Lifecycle hooks là các synchronous <a href="https://aws.amazon.com/lambda/">AWS Lambda</a> functions mà Amazon ECS control plane sẽ invoke thay cho bạn. Bạn có thể viết bất kỳ logic nào bạn muốn trong các function này bằng bất kỳ runtime language nào bạn chọn. Khi function đã thực thi xong logic của nó, nó phải return một <code>hookStatus</code> để Amazon ECS deployment có thể tiếp tục. Nếu <code>hookStatus</code> không được return, hoặc nếu function bị lỗi, thì Amazon ECS deployment sẽ rollback.</p>
<p>Các giá trị của hookStatus có thể là:</p>
<ul>
<li><code>SUCCEEDED</code>: deployment tiếp tục sang lifecycle stage tiếp theo.</li>
<li><code>FAILED</code>: deployment sẽ rollback về deployment cuối cùng đã thành công.</li>
<li><code>IN_PROGRESS</code>: Amazon ECS control plane sẽ invoke lại function sau một khoảng thời gian ngắn. Mặc định là 30 giây, nhưng có thể điều chỉnh bằng cách return một <code>callBackDelay</code>.</li>
</ul>
<p><img src="../../../images/C45-2.png" alt="anh"></p>
<h4 id="in_progress-hook-status">IN_PROGRESS hook status</h4>
<p><code>IN_PROGRESS</code> status cung cấp một cơ chế mạnh mẽ và linh hoạt để giám sát và kiểm soát Amazon ECS deployment. Function này là một synchronous event, do đó deployment chỉ có thể tạm dừng trong thời gian thực thi tối đa của một function (15 phút). Có thể có những tình huống bạn cần thực thi complex logic hoặc tạm dừng để chờ thêm dữ liệu, chẳng hạn như chờ một full test suite chạy trên test endpoint. Phản hồi <code>hookStatus</code> này cho phép bạn đạt được điều đó. Khi <code>IN_PROGRESS</code> hook status được return, Amazon ECS control plane sẽ invoke lại function sau 30 giây (hoặc khoảng thời gian được return trong key <code>callBackDelay</code>). Amazon ECS sẽ tiếp tục invoke function cho đến khi một <code>SUCCEEDED</code> hoặc <code>FAILED</code> hook status được return; do đó cho phép thực thi validation logic cần nhiều thời gian hơn so với thời gian thực thi của một function duy nhất.</p>
<h4 id="truyền-trạng-thái-với-hookdetails">Truyền trạng thái với hookDetails</h4>
<p>Lifecycle hooks thường được định nghĩa một lần và tái sử dụng trên nhiều ECS services trong một tổ chức. Để làm cho lifecycle hooks độc lập với ECS service, bạn có thể sử dụng <code>hookDetails</code> dictionary để truyền vào dữ liệu cụ thể của service khi tạo hoặc cập nhật một service. Dưới đây là một trích đoạn từ một <a href="https://docs.aws.amazon.com/AmazonECS/latest/APIReference/API_CreateService.html">ECS service</a> nơi chúng tôi đã định nghĩa một lifecycle hook và truyền vào một <a href="https://aws.amazon.com/s3/">Amazon S3 Bucket</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;hookTargetArn&#34;: </span><span style="color:#e6db74">&#34;arn:aws:lambda:&lt;region&gt;:&lt;account_id&gt;:function:&lt;function_name&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;roleArn&#34;: </span><span style="color:#e6db74">&#34;arn:aws:iam::&lt;account_id&gt;:role/&lt;iam_role_name&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;lifecycleStages&#34;: </span>[<span style="color:#e6db74">&#34;POST_TEST_TRAFFIC_SHIFT&#34;</span>],
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;hookDetails&#34;: { &#34;S3_BUCKET_NAME&#34;: </span><span style="color:#e6db74">&#34;mys3bucket&#34;</span> },
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Ngoài ra, bạn cũng có thể sử dụng <code>hookDetails</code> dictionary để truyền state giữa các lần invocation của cùng một lifecycle hook. Nếu một hook return <code>IN_PROGRESS</code> status, bạn cũng có thể bao gồm <code>hookDetails</code> dictionary với nhiều cặp key/value, loại bỏ nhu cầu phải lưu state ở nơi khác. Các trường hợp sử dụng phổ biến bao gồm truyền metric counters hoặc <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference-arns.html">Amazon Resource Names (ARNs)</a> của các external resources giữa các lần invocation. Lưu ý rằng dữ liệu được thêm vào <code>hookDetails</code> theo cách này chỉ tồn tại giữa các lần invocation của cùng một hook trong một deployment. Dữ liệu sẽ không được mang sang giữa các hook khác nhau trong cùng một deployment, hoặc cùng một hook ở các deployment khác nhau.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;hookStatus&#34;: </span><span style="color:#e6db74">&#34; IN_PROGRESS&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;callBackDelay&#34;: </span><span style="color:#ae81ff">90</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;hookDetails&#34;</span>:
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;SFN_EXECUTION_ARN&#34;: </span><span style="color:#e6db74">&#34;arn:aws:states:&lt;region&gt;:&lt;account_id&gt;:execution:&lt;sfn&gt;:&lt;id&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="pre_scale_up-hook">PRE_SCALE_UP hook</h4>
<p><code>PRE_SCALE_UP</code> lifecycle hook là duy nhất trong Amazon ECS deployments vì nó là hook duy nhất có sẵn cho cả <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/deployment-type-bluegreen.html">blue green deployment strategy</a> mới cũng như <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/deployment-type-ecs.html">rolling update strategy</a> hiện tại. <code>PRE_SCALE_UP</code> hook chạy trước khi các new tasks được tạo, cho phép bạn áp dụng admission logic trong Amazon ECS. Một cách sử dụng phổ biến của hook này là đánh giá Amazon ECS task definition dựa trên governance policy trước khi các tasks được scheduled. Trước đây, nếu bạn muốn áp dụng một policy cho các tasks, bạn chỉ có thể phản hồi khi task đã được scheduled. Một ví dụ về mô hình trước đó có thể được tìm thấy trong <a href="https://github.com/aws-samples/lambda-based-signature-verification">GitHub repository</a>. Mô hình trước đây có những hạn chế khi các tasks không an toàn hoặc có lỗ hổng có thể đang chạy trước khi policy của bạn phát hiện ra vi phạm. Hook mới này cho phép các trường hợp sử dụng như xác minh container image signature hoặc container image repository trước khi workload được scheduled.</p>
<h2 id="walkthrough">Walkthrough</h2>
<p>Trong walkthrough này, chúng tôi sẽ trình bày các patterns khác nhau để minh họa sức mạnh của lifecycle hooks. Trước tiên, chúng tôi sẽ trình diễn cách một <code>PRE_SCALE_UP</code> hook có thể được sử dụng như một dạng admission hook, tiếp theo, chúng tôi sẽ chỉ ra cách một <code>POST_TEST_TRAFFIC_SHIFT </code>hook có thể được sử dụng để áp dụng bước manual approval trước khi production traffic được chuyển đổi.</p>
<h4 id="điều-kiện-tiên-quyết">Điều kiện tiên quyết</h4>
<p>Để triển khai walkthrough này, bạn cần quyền truy cập vào một AWS account với một workstation đã cài đặt AWS Command Line Interface <a href="https://aws.amazon.com/cli/">(AWS CLI)</a>, AWS Cloud Development Kit <a href="https://aws.amazon.com/cdk/">(AWS CDK)</a>, và Docker Engine.</p>
<p>Trong suốt walkthrough này, chúng tôi sẽ deploy các resources lên một Amazon ECS cluster và vào một Amazon Virtual Private Cloud <a href="https://aws.amazon.com/vpc/">(Amazon VPC)</a>. Code cho walkthrough này có thể được tìm thấy trong một AWS CDK app trong sample <a href="https://github.com/aws-samples/sample-amazon-ecs-blue-green-deployment-patterns">GitHub repository</a> của chúng tôi.</p>
<ol>
<li>Clone GitHub Repository về máy</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ git clone https://github.com/aws-samples/sample-amazon-ecs-blue-green-deployment-patterns.git</span>
</span></span></code></pre></div><ol start="2">
<li>Triển khai AWS CDK app. AWS CDK app này chứa ba <a href="https://aws.amazon.com/cloudformation/">AWS CloudFormation stacks</a> riêng biệt. Nó tạo một Amazon VPC và <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html">Application Load Balancer (ALB)</a> trong stack đầu tiên. Trong stack thứ hai, nó tạo một ECS cluster và các AWS Identity and Access Management (<a href="https://aws.amazon.com/iam/">IAM</a>) roles cần thiết. Thứ ba, nó tạo một stack chứa các functions của chúng ta.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ cd sample-amazon-ecs-blue-green-deployment-patterns/ecs-bluegreen-lifecycle-hooks</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">$ npm install</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">$ npm run build</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">$ npx cdk deploy --all</span>
</span></span></code></pre></div><p>You can verify that the resources were created correctly with the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ aws cloudformation list-stacks \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">query &#34;StackSummaries[?starts_with(StackName, &#39;Ecs&#39;)].[StackName, StackStatus]&#34; \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">output table</span>
</span></span></code></pre></div><ol start="3">
<li>Trong kho lưu trữ này, chúng tôi có một template task definition và một service definition. Chúng tôi đã tạo một populate templates bash script trong repository để điền các template này với các giá trị phù hợp với môi trường của bạn.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ ./populate_templates.sh</span>
</span></span></code></pre></div><h4 id="admission-hook-demonstration">Admission hook demonstration</h4>
<p>Để minh họa cách một <code>PRE_SCALE_UP</code> hook có thể được sử dụng như một admission hook, chúng tôi sẽ khởi chạy một Amazon ECS service sử dụng container image từ một Amazon Elastic Container Registry (<a href="https://aws.amazon.com/ecr/">Amazon ECR</a>) public repository. Trong tình huống của chúng tôi, chúng tôi đã viết một policy trong function để đảm bảo rằng tất cả container images đều đến từ một private hoặc public Amazon ECR repository. Chúng tôi có thể thấy policy này được thực thi trong logs của lifecycle hook.</p>
<ol>
<li>Đầu tiên, chúng ta xem xét các resources mà chúng ta dự định deploy:
Bên trong service definition của chúng ta, bạn sẽ thấy một <code>PRE_SCALE_UP lifecycle</code> hook.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ cat outputs/service.json | jq -r &#39;.deploymentConfiguration.lifecycleHooks[0]&#39;</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;hookTargetArn&#34;: </span><span style="color:#e6db74">&#34;arn:aws:lambda:us-east-1:111222333444:function:EcsBluegreenHookStack-admissionFunction1D626CB0-FepCuhdYPhNn&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;roleArn&#34;: </span><span style="color:#e6db74">&#34;arn:aws:iam::111222333444:role/EcsBluegreenEcsStack-ECSLambdaInvokeRole2A82A552-yEE1nb8PewjH&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;lifecycleStages&#34;: </span>[
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;PRE_SCALE_UP&#34;</span>
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Function cho hook này xác minh container image của chúng ta bằng cách sử dụng một regex expression. Bạn có thể xem đoạn code này trên máy local bằng cách in source code ra.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ grep -A 20 &#34;def validate_container_images&#34; src/admissionFunction/app.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">def validate_container_images(container_image_list)</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Regex patterns to match Amazon ECR repository URLs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Format for private ECR: [account-id].dkr.ecr.[region].amazonaws.com/[repository-name]:[tag]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Format for public ECR: public.ecr.aws/aws-containers/[repository-name]:[tag]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">private_ecr_pattern = r&#34;^(\d+)\.dkr\.ecr\.([a-z0-9-]+)\.amazonaws\.com/.*&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">public_ecr_pattern = r&#34;^public\.ecr\.aws/aws-containers/.*&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">valid_images = True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">for container_image in container_image_list:#</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">image_url = container_image[&#34;image&#34;]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">logger.info(f&#34;Validating image: {image_url}&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">if re.match(private_ecr_pattern, image_url) or re.match(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">public_ecr_pattern, image_url</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">logger.info(f&#34;Image {image_url} is from an Amazon ECR repository&#34;)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">logger.warning(f&#34;Image {image_url} is NOT from an Amazon ECR repository&#34;)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">valid_images = False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">return valid_images</span>
</span></span></code></pre></div><p>Cuối cùng, bạn có thể thấy container image mà chúng ta đang cố gắng deploy trong task definition của mình.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ cat outputs/taskdef.json | jq -r &#39;.containerDefinitions[0].image&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">public.ecr.aws/aws-containers/retail-store-sample-ui:1.1.0</span>
</span></span></code></pre></div><ol start="2">
<li>Chúng tôi tạo <strong>Amazon ECS service</strong> và quan sát <strong>lifecycle hook</strong> hoạt động.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">aws ecs \</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">register-task-definition \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">cli-input-json file://outputs/taskdef.json</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">aws ecs \</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">create-service \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">cli-input-json file://outputs/service.json</span>
</span></span></code></pre></div><ol start="3">
<li>Trong Amazon ECS <a href="https://us-west-2.console.aws.amazon.com/ecs/home">console</a>, bạn có thể theo dõi deployment này. <strong>Current Deployment stage</strong> trong <strong>Deployment Tab</strong> cho chúng ta biết deployment đang ở lifecycle stage nào. Hãy nhớ rằng lifecycle hook đầu tiên của chúng ta chạy ở <code>PRE_SCALE_UP</code> stage.</li>
</ol>
<p><img src="../../../images/C45-3.png" alt="anh"></p>
<ol start="4">
<li>Bạn có thể xác minh rằng <strong>lifecycle hook</strong> đã thực thi thành công bằng cách truy cập <a href="https://aws.amazon.com/cloudwatch/">Amazon CloudWatch Logs console</a> và chọn <strong>Log Group</strong> có tên bắt đầu bằng <code>/aws/lambda/EcsBlugreenHookStack-admissionFunction</code>.</li>
</ol>
<p><img src="../../../images/C45-4.png" alt="anh"></p>
<p>Thành công! Container images được sử dụng trong task definition của chúng ta đã được xác minh theo policy trước khi task được scheduled.</p>
<h4 id="manual-approval-demonstration">Manual approval demonstration</h4>
<p>Phần thứ hai của walkthrough tập trung vào bước manual approval ở <code>POST_TEST_TRAFFIC_SHIFT</code> stage. Đây là một stage quan trọng trong deployment pipeline, vì nó diễn ra sau khi test traffic endpoint đã được chuyển sang các green tasks của chúng ta (cho phép bạn chạy test suite), nhưng trước khi production traffic endpoint được di chuyển.
Trong walkthrough này, chúng tôi thực hiện một bước manual approval trước khi di chuyển production traffic. Có nhiều cách để thực hiện bước manual approval, nhưng trong minh họa này, chúng tôi sử dụng một file và một <a href="https://aws.amazon.com/s3/">Amazon S3</a> bucket. Function trong lifecycle hook của chúng tôi sẽ cố gắng tìm một file trong S3 bucket có tên trùng với Amazon ECS service revision. Nếu file tồn tại, deployment pipeline sẽ tiếp tục. Nếu file không tồn tại, hook sẽ return trạng thái <code>IN_PROGRESS</code> và chúng tôi sẽ thử lại sau 30 giây.</p>
<ol>
<li>Đầu tiên, chúng ta xem xét các resources mà chúng ta dự định deploy.
Bên trong service definition của chúng ta, bạn sẽ thấy một <code>POST_TEST_TRAFFIC_SHIFT</code> lifecycle hook.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ cat outputs/service.json | jq -r &#39;.deploymentConfiguration.lifecycleHooks[1]&#39;</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;hookTargetArn&#34;: </span><span style="color:#e6db74">&#34;arn:aws:lambda:us-east-1:111222333444:function:EcsBluegreenHookStack-approvalFunctionC7093965-J3YoEQtxR679&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;roleArn&#34;: </span><span style="color:#e6db74">&#34;arn:aws:iam::111222333444:role/EcsBluegreenEcsStack-ECSLambdaInvokeRole2A82A552-9OcKcmXkLe9c&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;lifecycleStages&#34;: </span>[
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;POST_TEST_TRAFFIC_SHIFT&#34;</span>
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Xem source code của function trên máy local cho phép chúng ta kiểm tra logic để tìm file Amazon S3. Chúng tôi đang sử dụng <a href="https://aws.amazon.com/sdk-for-python/">boto3client</a> để cố gắng tìm head object của một file có tên trùng với Amazon ECS service revision ID của chúng ta.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ grep -A 20 &#34;def check_s3_file&#34; src/approvalFunction/app.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">def check_s3_file(s3_bucket, revision_arn)</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract the revision from the ARN (everything after the last &#39;/&#39;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">revision = revision_arn.split(&#34;/&#34;)[-1]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">file_name = f&#34;{revision}.txt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">logger.info(f&#34;Checking if file {file_name} exists in bucket {s3_bucket}&#34;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create S3 client</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">s3_client = boto3.client(&#34;s3&#34;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Use head_object to check if the file exists</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">s3_client.head_object(Bucket=s3_bucket, Key=file_name)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">logger.info(f&#34;File {file_name} exists in bucket {s3_bucket}&#34;)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">return True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">except ClientError as e</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">if e.response[&#34;Error&#34;][&#34;Code&#34;] == &#34;404&#34;:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># The file does not exist</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">logger.info(f&#34;File {file_name} does not exist in bucket {s3_bucket}&#34;)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">return False</span>
</span></span></code></pre></div><ol start="2">
<li>Để kích hoạt một deployment, chúng ta cập nhật Amazon ECS service với một force action. Điều này buộc Amazon ECS tạo một service revision mới và redeploy tất cả các tasks, ngay cả khi service specification không thay đổi.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">export CLUSTER_NAME=$(cat outputs/service.json | jq -r &#39;.cluster&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">export SERVICE_NAME=$(cat outputs/service.json | jq -r &#39;.serviceName&#39;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">aws ecs \</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">update-service \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">service $SERVICE_NAME \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">cluster $CLUSTER_NAME \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">force</span>
</span></span></code></pre></div><ol start="3">
<li>Bạn có thể theo dõi deployment đang diễn ra trong Amazon <a href="https://us-west-2.console.aws.amazon.com/ecs/home">ECS console</a>, quan sát service di chuyển qua các lifecycle stages khác nhau. Khi deployment đạt đến <code>POST_TEST_TRAFFIC_SHIFT</code> stage, chúng ta có thể kiểm tra tiến trình của hook.</li>
</ol>
<p><img src="../../../images/C45-5.png" alt="anh"></p>
<ol start="4">
<li>CloudWatch Logs console cung cấp cho chúng ta cái nhìn về những gì đang diễn ra ở stage này. Trong một log group có tên bắt đầu bằng <code>/aws/lambda/EcsBlugreenHookStack-approvalFunction</code>, chúng ta sẽ thấy các invocation của function mỗi 30 giây, cố gắng truy xuất file từ Amazon S3.</li>
</ol>
<p><img src="../../../images/C45-6.png" alt="anh"></p>
<ol start="5">
<li>Để cho phép deployment pipeline tiếp tục, chúng ta tải một file lên S3 bucket. Trước tiên, chúng ta cần lấy Amazon ECS service revision ARN, rút gọn chỉ còn service revision ID, và sử dụng nó làm tên file.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">export S3_BUCKET_NAME=$(aws cloudformation describe-stacks \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">stack-name EcsBluegreenHookStack \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">query &#39;Stacks[0].Outputs[?OutputKey==`ApprovalBucketName`].OutputValue&#39; \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">output text)</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">export ECS_SERVICE_REVISION=$(aws ecs \</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">list-service-deployments \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">service $SERVICE_NAME \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">cluster $CLUSTER_NAME \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">query &#39;serviceDeployments[?status==`IN_PROGRESS`].targetServiceRevisionArn&#39; \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">output text)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">SERVICE_REVISION_ID=$(echo &#34;$ECS_SERVICE_REVISION&#34; | awk -F/ &#39;{print $NF}&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">touch $SERVICE_REVISION_ID.txt</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">aws s3 cp $SERVICE_REVISION_ID.txt s3://$S3_BUCKET_NAME/$SERVICE_REVISION_ID.txt</span>
</span></span></code></pre></div><ol start="6">
<li>Bây giờ khi file đã tồn tại trong Amazon S3, chúng ta có thể quay lại Amazon ECS console và quan sát deployment hoàn tất.</li>
</ol>
<p><img src="../../../images/C45-7.png" alt="anh"></p>
<h2 id="dọn-dẹp">Dọn dẹp</h2>
<p>Để dọn dẹp các AWS resources đã sử dụng trong suốt walkthrough này, chúng ta phải xóa Amazon ECS service.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ aws ecs \</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">delete-service \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">service $SERVICE_NAME \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">cluster $CLUSTER_NAME \</span>
</span></span><span style="display:flex;"><span>--<span style="color:#ae81ff">force</span>
</span></span></code></pre></div><p>Tiếp theo, chúng ta xóa các <strong>CloudFormation</strong> stacks bằng <strong>AWS CDK</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">$ cdk destroy --all</span>
</span></span></code></pre></div><h2 id="kết-luận">Kết luận</h2>
<p>Lifecycle hooks trong Amazon ECS cung cấp vô vàn khả năng để tùy chỉnh deployment pipeline của bạn. Trong bài viết này, chúng tôi đã đề cập đến một vài trường hợp sử dụng phổ biến của các hook này, chẳng hạn như đánh giá một deployment theo governance policies, cũng như thực hiện một bước manual approval. Để tìm hiểu thêm, hãy truy cập Amazon ECS lifecycle hooks <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/deployment-type-bluegreen.html">documentation</a> và xem các minh họa trên kênh Containers from the Couch trên <a href="https://www.youtube.com/ContainersFromTheCouch">YouTube</a>.</p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="../../../vi/3-blogstranslated/" title="Các bài blogs đã dịch"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="../../../vi/3-blogstranslated/3.2-blog2/" title="Blog 2" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="../../../js/clipboard.min.js?1761460639"></script>
    <script src="../../../js/perfect-scrollbar.min.js?1761460639"></script>
    <script src="../../../js/perfect-scrollbar.jquery.min.js?1761460639"></script>
    <script src="../../../js/jquery.sticky.js?1761460639"></script>
    <script src="../../../js/featherlight.min.js?1761460639"></script>
    <script src="../../../js/highlight.pack.js?1761460639"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="../../../js/modernizr.custom-3.6.0.js?1761460639"></script>
    <script src="../../../js/learn.js?1761460639"></script>
    <script src="../../../js/hugo-learn.js?1761460639"></script>

    <link href="../../../mermaid/mermaid.css?1761460639" rel="stylesheet" />
    <script src="../../../mermaid/mermaid.js?1761460639"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function (i, s, o, g, r, a, m) {
    i["GoogleAnalyticsObject"] = r;
    ((i[r] =
      i[r] ||
      function () {
        (i[r].q = i[r].q || []).push(arguments);
      }),
      (i[r].l = 1 * new Date()));
    ((a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]));
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m);
  })(
    window,
    document,
    "script",
    "https://www.google-analytics.com/analytics.js",
    "ga",
  );

  ga("create", "UA-158079754-2", "auto");
  ga("send", "pageview");
</script>

  </body>
</html>
